# Web Scraper Service - GitHub Actions Workflow
#
# This workflow is triggered by a repository_dispatch event from the main app.
# It scrapes the provided URLs and indexes them to Upstash Vector.
#
# Trigger payload:
# {
#   "event_type": "scrape",
#   "client_payload": {
#     "urls_json": "[\"https://example.com\"]",
#     "job_id": "abc123",
#     "brand_slug": "mysite",
#     "callback_url": "https://app.com/api/setup/scraper-callback"
#   }
# }

name: Web Scraper

on:
  repository_dispatch:
    types: [scrape]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      urls_json:
        description: "JSON array of URLs to scrape"
        required: true
        default: '["https://example.com"]'
      brand_slug:
        description: "Brand identifier for indexing"
        required: true
        default: "test"
      job_id:
        description: "Job ID for tracking"
        required: false
        default: ""
      engine:
        description: "Scraper engine (cheerio, puppeteer, or firecrawl)"
        required: false
        default: "cheerio"
        type: choice
        options:
          - cheerio
          - puppeteer
          - firecrawl
      total_chunks:
        description: "Total number of chunks for parallel processing"
        required: false
        default: "1"
      chunk_id:
        description: "Current chunk ID (1-based) for this job"
        required: false
        default: "1"

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      matrix:
        # Create matrix for parallel chunks
        chunk: ${{ fromJSON(github.event.client_payload.total_chunks || github.event.inputs.total_chunks || '[1]') }}
    name: scrape-chunk-${{ matrix.chunk }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (without Puppeteer)
        run: npm install --ignore-optional

      - name: Build TypeScript
        run: npm run build

      # Install Puppeteer only when using puppeteer engine
      - name: Install Puppeteer
        if: github.event.client_payload.engine == 'puppeteer' || github.event.inputs.engine == 'puppeteer'
        run: npm install puppeteer

      # Install Chrome for Puppeteer (if using puppeteer engine)
      - name: Setup Chrome
        if: github.event.client_payload.engine == 'puppeteer' || github.event.inputs.engine == 'puppeteer'
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable

      - name: Run Scraper
        env:
          # Set memory limit and enable garbage collection (2GB for Cheerio, 4GB for Puppeteer)
          NODE_OPTIONS: ${{ (github.event.client_payload.engine == 'puppeteer' || github.event.inputs.engine == 'puppeteer') && '--max-old-space-size=4096 --expose-gc' || '--max-old-space-size=2048 --expose-gc' }}
          # Upstash credentials (from repository secrets)
          UPSTASH_VECTOR_REST_URL: ${{ secrets.UPSTASH_VECTOR_REST_URL }}
          UPSTASH_VECTOR_REST_TOKEN: ${{ secrets.UPSTASH_VECTOR_REST_TOKEN }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}

          # Callback configuration
          CALLBACK_SECRET: ${{ secrets.SCRAPER_CALLBACK_SECRET }}

          # Firecrawl API key (for firecrawl engine)
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}

          # Job parameters (from dispatch or manual input)
          URLS_JSON: >
            ${{ matrix.chunk == 1 && (github.event.client_payload.chunk_1 || github.event.inputs.urls_json) ||
            matrix.chunk == 2 && (github.event.client_payload.chunk_2 || github.event.inputs.urls_json) ||
            matrix.chunk == 3 && (github.event.client_payload.chunk_3 || github.event.inputs.urls_json) ||
            matrix.chunk == 4 && (github.event.client_payload.chunk_4 || github.event.inputs.urls_json) ||
            matrix.chunk == 5 && (github.event.client_payload.chunk_5 || github.event.inputs.urls_json) ||
            matrix.chunk == 6 && (github.event.client_payload.chunk_6 || github.event.inputs.urls_json) ||
            matrix.chunk == 7 && (github.event.client_payload.chunk_7 || github.event.inputs.urls_json) ||
            matrix.chunk == 8 && (github.event.client_payload.chunk_8 || github.event.inputs.urls_json) ||
            matrix.chunk == 9 && (github.event.client_payload.chunk_9 || github.event.inputs.urls_json) ||
            matrix.chunk == 10 && (github.event.client_payload.chunk_10 || github.event.inputs.urls_json) ||
            github.event.inputs.urls_json }}
          BRAND_SLUG: ${{ github.event.client_payload.brand_slug || github.event.inputs.brand_slug }}
          JOB_ID: ${{ github.event.client_payload.job_id || github.event.inputs.job_id }}
          CALLBACK_URL: ${{ github.event.client_payload.callback_url || '' }}
          SCRAPER_ENGINE: ${{ github.event.client_payload.engine || github.event.inputs.engine || 'cheerio' }}

          # Chunk processing metadata
          CHUNK_ID: ${{ matrix.chunk }}
          TOTAL_CHUNKS: ${{ github.event.client_payload.total_chunks_count || github.event.inputs.total_chunks || 1 }}
        run: |
          echo "ðŸš€ Starting scrape job (Chunk $CHUNK_ID/$TOTAL_CHUNKS)"
          echo "   Brand: $BRAND_SLUG"
          echo "   Job ID: $JOB_ID"
          echo "   Engine: $SCRAPER_ENGINE"
          echo "   Memory limit: $NODE_OPTIONS"

          npm run scrape

      - name: Job Summary
        if: always()
        run: |
          echo "## Scrape Job Complete (Chunk ${{ env.CHUNK_ID }}/${{ env.TOTAL_CHUNKS }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Brand:** ${{ github.event.client_payload.brand_slug || github.event.inputs.brand_slug }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Job ID:** ${{ github.event.client_payload.job_id || github.event.inputs.job_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Chunk:** ${{ env.CHUNK_ID }}/${{ env.TOTAL_CHUNKS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
